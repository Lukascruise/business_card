name: Discord Notifications

on:
  pull_request:
    types: [opened, review_requested, closed]
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # PR ìƒì„± ì•Œë¦¼
      - name: Notify on PR Opened
        if: github.event.action == 'opened'
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
          ADDITIONS: ${{ github.event.pull_request.additions }}
          DELETIONS: ${{ github.event.pull_request.deletions }}
          CREATED_AT: ${{ github.event.pull_request.created_at }}
        run: |
          curl -H "Content-Type: application/json" \
              -X POST \
              -d "{
                \"embeds\": [{
                  \"title\": \"ğŸ†• ìƒˆë¡œìš´ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\",
                  \"description\": \"[$PR_TITLE]($PR_URL)\",
                  \"color\": 3447003,
                  \"fields\": [
                    { \"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"$PR_AUTHOR\", \"inline\": true },
                    { \"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"\`$HEAD_REF\` â†’ \`$BASE_REF\`\", \"inline\": true },
                    { \"name\": \"ğŸ“Š ë³€ê²½ì‚¬í•­\", \"value\": \"+$ADDITIONS -$DELETIONS\", \"inline\": true }
                  ],
                  \"timestamp\": \"$CREATED_AT\"
                }]
              }" \
              ${{ secrets.DISCORD_WEBHOOK_URL }}

      # ë¦¬ë·° ìš”ì²­ ì•Œë¦¼
      - name: Mention Reviewers
        if: github.event.action == 'review_requested'
        env:
          REVIEWERS_JSON: ${{ toJSON(github.event.pull_request.requested_reviewers) }}
          CURRENT_REVIEWER: ${{ github.event.requested_reviewer.login }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          CHANGED_FILES: ${{ github.event.pull_request.changed_files }}
          ADDITIONS: ${{ github.event.pull_request.additions }}
          DELETIONS: ${{ github.event.pull_request.deletions }}
        run: |
          FIRST_REVIEWER=$(echo "$REVIEWERS_JSON" | jq -r '.[0].login // empty')

          if [ "$CURRENT_REVIEWER" = "$FIRST_REVIEWER" ] || [ -z "$FIRST_REVIEWER" ]; then
            MENTIONS=""
            for login in $(echo "$REVIEWERS_JSON" | jq -r '.[] | .login'); do
              case "$login" in
                "Lukascruise") MENTIONS="$MENTIONS <@719200574096015391>" ;;
                *) MENTIONS="$MENTIONS @$login" ;;
              esac
            done

            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{
                   \"content\": \"ğŸ” **ë¦¬ë·° ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!** $MENTIONS\",
                   \"embeds\": [{
                     \"title\": \"ë¦¬ë·°ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤! ğŸ‘€\",
                     \"description\": \"[$PR_TITLE]($PR_URL)\",
                     \"color\": 16776960,
                     \"fields\": [
                       { \"name\": \"ğŸ‘¤ PR ì‘ì„±ì\", \"value\": \"$PR_AUTHOR\", \"inline\": true },
                       { \"name\": \"ğŸ“ ë³€ê²½ì‚¬í•­\", \"value\": \"íŒŒì¼ $CHANGED_FILESê°œ | +$ADDITIONS -$DELETIONS\", \"inline\": false }
                     ]
                   }]
                 }" \
                 ${{ secrets.DISCORD_WEBHOOK_URL }}
          fi

      # ë¦¬ë·° ìŠ¹ì¸ ì•Œë¦¼
      - name: Notify on Review Approved
        if: github.event.review.state == 'approved'
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          REVIEWER: ${{ github.event.review.user.login }}
        run: |
          case "$PR_AUTHOR" in
            "Lukascruise") FINAL_MENTION="<@719200574096015391>" ;;
            *) FINAL_MENTION="@$PR_AUTHOR" ;;
          esac

          curl -H "Content-Type: application/json" \
              -X POST \
              -d "{
                \"content\": \"ğŸ‘ **ë¦¬ë·°ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!** $FINAL_MENTION\",
                \"embeds\": [{
                  \"title\": \"âœ… ë¦¬ë·° ìŠ¹ì¸ ì™„ë£Œ!\",
                  \"description\": \"[$PR_TITLE]($PR_URL)\",
                  \"color\": 65280,
                  \"fields\": [
                    { \"name\": \"ğŸ‘€ ë¦¬ë·°ì–´\", \"value\": \"$REVIEWER\", \"inline\": true }
                  ]
                }]
              }" \
              ${{ secrets.DISCORD_WEBHOOK_URL }}

      # ë³€ê²½ ì‚¬í•­ ìš”ì²­ ì•Œë¦¼
      - name: Notify on Changes Requested
        if: github.event.review.state == 'changes_requested'
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          REVIEWER: ${{ github.event.review.user.login }}
        run: |
          case "$PR_AUTHOR" in
            "Lukascruise") FINAL_MENTION="<@719200574096015391>" ;;
            *) FINAL_MENTION="@$PR_AUTHOR" ;;
          esac

          curl -H "Content-Type: application/json" \
              -X POST \
              -d "{
                \"content\": \"ğŸ”„ **ë³€ê²½ì‚¬í•­ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤!** $FINAL_MENTION\",
                \"embeds\": [{
                  \"title\": \"â— ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤\",
                  \"description\": \"[$PR_TITLE]($PR_URL)\",
                  \"color\": 16776960,
                  \"fields\": [
                    { \"name\": \"ğŸ‘€ ë¦¬ë·°ì–´\", \"value\": \"$REVIEWER\", \"inline\": true }
                  ]
                }]
              }" \
              ${{ secrets.DISCORD_WEBHOOK_URL }}
